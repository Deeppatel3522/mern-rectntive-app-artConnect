name: ArtConnect App Expo Build & Firebase App Distribution

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.13.0' # Using a stable LTS version

    - name: Install dependencies
      run: |
        cd ArtConnect/client
        npm install
        cd ../server
        npm install

    - name: Install EAS CLI
      run: npm install -g eas-cli

    - name: Authenticate with Expo
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: eas login --non-interactive

    - name: Build the app (Production)
      working-directory: ArtConnect/client
      env:
        EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
      run: |
        # Build the app and output JSON with artifact details
        eas build --platform android --profile production --non-interactive --json > build-output.json
        # Extract the artifact URL
        ARTIFACT_URL=$(cat build-output.json | jq -r '.artifacts.buildUrl')
        if [ -z "$ARTIFACT_URL" ]; then
          echo "Error: No artifact URL found in build output"
          cat build-output.json
          exit 1
        fi
        echo "ARTIFACT_URL=$ARTIFACT_URL" >> $GITHUB_ENV

    - name: Download the .aab file
      run: |
        # Download the .aab file from the artifact URL
        curl -L -o app.aab "$ARTIFACT_URL"
        # Verify the file exists
        ls -lh app.aab

    - name: Install Firebase CLI
      run: npm install -g firebase-tools

    - name: Upload to Firebase App Distribution
      run: |
        firebase appdistribution:distribute app.aab \
          --app ${{ secrets.FIREBASE_APP_ID }} \
          --groups beta-tester \
          --release-notes "New automated build from GitHub Actions ðŸš€" \
          --token ${{ secrets.FIREBASE_TOKEN }}
